<!-- Display any message from the app, then clear it from history -->

{% if "_message" in params %}
  {% if params._message.id %}
  <div class="alert alert-success" role="alert">
    Stored new document as {{ params._message.id }}!
  </div>
  {% endif %}

  {% if params._message.error %}
  <div class="alert alert-success" role="alert">
    Unable to store document: {{ params._message.error }}
  </div>
  {% endif %}

  {% if page_url != req_url %}
  <script>
    window.history.pushState({path: "{{ req_url }}" }, "", "{{ req_url }}");
  </script>
  {% endif %}
{% endif %}




<div>
  <p>
    <a class="btn btn-light justify-content-left" data-toggle="collapse" href="#collapseDocumentForm" role="button" aria-expanded="false" aria-controls="collapseDocumentForm">
    Store a document
    </a>

    {% if search_response.tags %}
    <a class="btn btn-light justify-content-left" data-toggle="collapse" href="#collapseTagList" role="button" aria-expanded="false" aria-controls="collapseTagList">
    Show tags
    </a>
    {% endif %}
  </p>
</div>

{% if search_response.tags %}
<div class="collapse{% if params.get('tag_list') == 'show' %} show{% endif %}" id="collapseTagList">
  <div class="card card-body">
    <ul style="margin-bottom: 0;">
    {% for tag in search_response.tags|sort %}
      {% if not loop.first %}
        {% if tag.count(":") > loop.previtem.count(":") %}
          {% if tag.startswith(loop.previtem) %}<ul>
          {% else %}
          <li>{{ tag.rsplit(":", 1)[0] }}:</li><ul>
          {% endif %}
        {% endif %}
        {% if tag.count(":") < loop.previtem.count(":") %}</ul>{% endif %}
        {% if tag.count(":") == loop.previtem.count(":") and tag.count(":") > 0 and tag.rsplit(":", 1)[0] != loop.previtem.rsplit(":", 1)[0] %}</ul><li>{{ tag.rsplit(":", 1)[0] }}:</li><ul>{% endif %}
      {% else %}
        {% if tag.count(":") > 0 %}
        <li>{{ tag.rsplit(":", 1)[0] }}:</li><ul>
        {% endif %}
      {% endif %}
      <li>{% if tag not in search_options.tag_query %}
        <a href="#" onclick="window.location = addTagToUrl('{{ tag }}');">{{ tag }}</a>
      {% else %}
        {{ tag }}
      {% endif %} ({{ search_response.tags[tag] }})</li>

      {% if loop.last %}
        {% for i in range(tag.count(":")) %}</ul>{% endfor %}
      {% endif %}
    {% endfor %}
    </ul>
  </div>
</div>
{% endif %}

<div class="collapse{% if params.get('form') == 'show' %} show{% endif %}" id="collapseDocumentForm">
  <div class="card">
    <div class="card-header">
      Store a document
    </div>
    <div class="card-body">
      <form action="upload" method="post" enctype="multipart/form-data">
        <div class="form-group">
          <label for="form__title">Title</label>
          <input name="title" type="text" class="form-control" id="form__title" placeholder="Enter title" required>
        </div>

        <div class="form-group">
          <label for="form_tags">Tags</label>
          <input name="tags" type="text" class="form-control" id="form_tags" placeholder="Enter tags (space-separated)" value="{{ ' '.join(req_url.get('tag')) }}" required>
        </div>

        <div class="form-group">
          <label for="form__file">File</label>
          <input name="file" type="file" class="form-control-file" id="form__file" required>
        </div>

        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
  </div>
</div>

{% if search_options.tag_query %}
<p class="tag_query">Filtering to documents with
  <strong>{{ t }}</strong>
  {% for t in search_options.tag_query %}
    <span class="tag_query__tag">
      <strong>{{ t }}</strong>
      <a href="#" onclick="window.location = deleteTag('{{ t }}');" class="text-danger">x</a>
    </span>
  {% endfor %}
</p>
{% endif %}


<script>
  $("#collapseDocumentForm")
    .on("show.bs.collapse", function() {
      var newUrl = addQueryParameter("form", "show");
      window.history.pushState(newUrl, "", newUrl);
    })
    .on("hide.bs.collapse", function() {
      var newUrl = deleteQueryParameter("form");
      window.history.pushState(newUrl, "", newUrl);
    })

  $("#collapseTagList")
    .on("show.bs.collapse", function() {
      var newUrl = addQueryParameter("tag_list", "show");
      window.history.pushState(newUrl, "", newUrl);
    })
    .on("hide.bs.collapse", function() {
      var newUrl = deleteQueryParameter("tag_list");
      window.history.pushState(newUrl, "", newUrl);
    })
</script>
